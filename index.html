<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Registros de Trabajo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f4f9; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .controls { 
            display: flex; 
            flex-wrap: wrap; /* Permite que los controles se envuelvan en pantallas pequeñas */
            gap: 20px; 
            margin-bottom: 20px; 
            align-items: center; 
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .controls label { font-weight: bold; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; }
        canvas { background: #fff; padding: 15px; border-radius: 6px; }
        #loading { text-align: center; color: #555; padding: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Dashboard de Registros de Trabajo</h1>
    
    <div id="loading">Cargando datos desde Google Sheet...</div>

    <div class="controls" style="display: none;" id="dashboard-controls">
        
        <div>
            <label for="filter-select">Filtro por Columna:</label>
            <select id="filter-select" onchange="renderCharts()">
                <option value="all">Todos los Registros</option>
                </select>
        </div>

        <div>
            <label for="chart-type-select">Tipo de Gráfico:</label>
            <select id="chart-type-select" onchange="updateChartType(this.value)">
                <option value="bar">Barras</option>
                <option value="line">Líneas</option>
                <option value="pie">Torta</option>
                <option value="doughnut">Rosquilla</option>
            </select>
        </div>
    </div>

    <div>
        <canvas id="myChart"></canvas>
    </div>
</div>

<script>
    // ⚠️ IMPORTANTE: REEMPLAZA ESTA URL CON LA URL DE LA APLICACIÓN WEB QUE DESPLEGASTE EN GOOGLE APPS SCRIPT.
    const APP_SCRIPT_URL = 'https://script.google.com/a/macros/esan.edu.pe/s/AKfycbzlhg-rb_cfXU0Ki8CTioLVQ2ZmNXd8f7JB9niws-s2h8OW8B5Eiol1NZiT6bG79rcV/exec'; 
    
    // ⚙️ COLUMNAS DE CONFIGURACIÓN
    // 1. Columna que contiene las categorías a AGREGAR y FILTRAR (debe ser el encabezado de tu Sheet).
    const FILTER_COLUMN = 'Nivel'; // EJEMPLO: 'Nivel', 'Proyecto', 'Estado'
    // 2. Columna que contiene el valor NUMÉRICO para la métrica (debe ser el encabezado de tu Sheet).
    const METRIC_COLUMN = 'Horas'; // EJEMPLO: 'Horas', 'Cantidad', 'Costo'

    let fullData = [];
    let myChart = null;

    // Registrar el plugin de Data Labels de Chart.js
    Chart.register(ChartDataLabels);

    /**
     * Carga los datos desde la URL de Google Apps Script.
     */
    async function fetchData() {
        try {
            const response = await fetch(APP_SCRIPT_URL);
            if (!response.ok) {
                throw new Error('Código HTTP ' + response.status + '. ¿URL o despliegue correctos?');
            }
            const data = await response.json();
            
            // Si el Apps Script tiene éxito, usa los registros
            fullData = data.records;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dashboard-controls').style.display = 'flex';
            
            setupFilters();
            renderCharts();
        } catch (error) {
            console.error('Error al obtener datos:', error);
            document.getElementById('loading').innerText = '❌ Error al cargar los datos. Revisa la consola y la URL del Apps Script.';
        }
    }

    /**
     * Llena el selector de filtro con los valores únicos de la columna de filtro.
     */
    function setupFilters() {
        if (fullData.length === 0) return;

        const filterSelect = document.getElementById('filter-select');
        const uniqueValues = new Set();
        
        // El filtro inicial es para todos los valores de la columna de filtro
        fullData.forEach(record => {
            if (record.hasOwnProperty(FILTER_COLUMN) && record[FILTER_COLUMN]) {
                uniqueValues.add(record[FILTER_COLUMN]);
            }
        });

        // Limpiar el selector (excepto la opción "Todos")
        Array.from(filterSelect.options).slice(1).forEach(option => filterSelect.removeChild(option));

        // Crear opciones para cada valor único
        uniqueValues.forEach(value => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = `Agrupar por: ${value}`;
            filterSelect.appendChild(option);
        });
    }

    /**
     * Procesa y agrega los datos para el gráfico.
     * @param {Array} dataToProcess - El subconjunto de datos a utilizar.
     */
    function processData(dataToProcess) {
        const aggregation = {};
        
        dataToProcess.forEach(record => {
            const category = record[FILTER_COLUMN];
            // Intentar convertir la métrica a número. Si falla, se usa 1 (para un conteo de registros).
            const metricValue = parseFloat(record[METRIC_COLUMN]) || 1; 

            if (category) {
                if (aggregation[category]) {
                    aggregation[category] += metricValue;
                } else {
                    aggregation[category] = metricValue;
                }
            }
        });

        const labels = Object.keys(aggregation);
        const values = Object.values(aggregation);
        
        return { labels, values };
    }

    /**
     * Renderiza o actualiza el gráfico con los datos filtrados.
     */
    function renderCharts() {
        const selectedFilter = document.getElementById('filter-select').value;
        const selectedType = document.getElementById('chart-type-select').value;
        
        let filteredData = fullData;

        // Lógica de filtrado: si el valor seleccionado no es 'all', se filtra por ese valor
        if (selectedFilter !== 'all') {
            filteredData = fullData.filter(record => record[FILTER_COLUMN] == selectedFilter);
        }

        const { labels, values } = processData(filteredData);
        
        const chartTitle = selectedFilter === 'all' 
            ? `Total de ${METRIC_COLUMN} por ${FILTER_COLUMN}` 
            : `${METRIC_COLUMN} para ${FILTER_COLUMN}: ${selectedFilter}`;
        
        // Destruir el gráfico anterior para limpiarlo
        if (myChart) {
            myChart.destroy();
        }

        const ctx = document.getElementById('myChart').getContext('2d');
        myChart = new Chart(ctx, {
            type: selectedType, 
            data: {
                labels: labels,
                datasets: [{
                    label: METRIC_COLUMN,
                    data: values,
                    // Colores de ejemplo
                    backgroundColor: ['#4e79a7', '#f28e2c', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1', '#ff9da7', '#9c755f', '#bab0ac'],
                    borderColor: 'rgba(0, 0, 0, 0.1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: chartTitle
                    },
                    // Muestra los valores directamente en el gráfico
                    datalabels: {
                        color: '#333',
                        anchor: 'end',
                        align: 'top',
                        // Formato de los números
                        formatter: (value) => {
                             return new Intl.NumberFormat('es-ES', { maximumFractionDigits: 2 }).format(value);
                        }
                    },
                    // Configuración de Tooltips
                    tooltip: {
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                // Formato para el tooltip
                                label += new Intl.NumberFormat('es-ES', { maximumFractionDigits: 2 }).format(context.parsed.y !== undefined ? context.parsed.y : context.parsed);
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        // Ocultar el eje Y en gráficos de torta/rosquilla
                        display: (selectedType !== 'pie' && selectedType !== 'doughnut'), 
                        title: {
                            display: true,
                            text: METRIC_COLUMN
                        }
                    }
                }
            }
        });
    }

    /**
     * Cambia el tipo de gráfico sin recargar los datos.
     * @param {string} newType - El nuevo tipo de gráfico (bar, line, pie, etc.).
     */
    function updateChartType(newType) {
        if (myChart) {
            myChart.config.type = newType;
            // Ajustar la visibilidad del eje Y
            myChart.options.scales.y.display = (newType !== 'pie' && newType !== 'doughnut');
            myChart.update();
        }
    }

    // Iniciar la carga de datos al cargar la página
    fetchData();

</script>

</body>
</html>
